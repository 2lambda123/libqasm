name: v3_distro artifact download

on:
  push:
    branches:
      - v3
  pull_request:

jobs:
  v3_distro-artifact-download:
    name: 'v3_distro artifact download'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for 'v3_distro artifact upload' workflow to succeed
        uses: ArcticLampyrid/action-wait-for-workflow@v1.0.3
        with:
          sha: ${{ github.sha }}
          workflow: v3_distro-artifact-upload.yml
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: v3_distro
          fetch-depth: 0
      - name: Download v3_distro-artifact
        id: download-v3_distro-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          branch: v3
          name: v3_distro-artifact
          path: artifact
          workflow: v3_distro-artifact-upload.yml
          workflow_conclusion: success
      - name: Display structure of downloaded files
        run: ls -R
        working-directory: artifact
      - name: Copy artifact files to destination
        run: |
          cp artifact/build/_deps/tree-gen-src/include/* include/tree-gen
          cp artifact/build/_deps/tree-gen-src/src/tree-all.cpp src/tree-gen
          cp artifact/build/include/v1/* include/v1
          cp artifact/build/py_gen/v1/* python/v1
          cp artifact/build/src/*.hpp include
          cp artifact/build/src/*.{cpp,txt} src
          cp artifact/build/src/v1/*.hpp include/v1
          cp artifact/build/src/v1/*.{cpp,txt} src/v1
          cp artifact/src/*.{l,y} src
          cp artifact/src/v1/* src/v1
      - name: Update artifact files
        run: |
          python scripts/update_artifact_files.py
      - name: Get latest CMake
        uses: lukka/get-cmake@latest
      - name: Configure
        run: |
          mkdir ${{ github.workspace }}/build 
          cd ${{ github.workspace }}/build
          cmake .. -B . -DCMAKE_BUILD_TYPE=Debug -DLIBQASM_BUILD_TESTS=ON -DLIBQASM_COMPAT=ON
      - name: Build C++
        run: |
          cd ${{ github.workspace }}/build
          cmake --build . --parallel
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel pytest numpy
          echo "LIBQASM_BUILD_TYPE=Debug" >> $GITHUB_ENV
      - name: Build Python
        env:
          NPROCS: 100
        run: python -m pip install --verbose .
      - name: Run C++ tests
        run: ctest -C Debug --output-on-failure
      - name: Run Python tests
        run: python -m pytest
      - name: Commit files
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -a -m "Updating v3_distro with new generated files from v3"
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: v3_distro
          force_with_lease: true
